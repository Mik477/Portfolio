<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocation Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success { border-color: #22c55e; background: #f0fdf4; }
        .info { border-color: #3b82f6; background: #eff6ff; }
        .warning { border-color: #f59e0b; background: #fffbeb; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        pre {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code { font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <h1>üåç IP Geolocation Test Tool</h1>
    <p>Use this page to test your IP-based geolocation implementation.</p>

    <div class="test-card info">
        <h2>üìç Your Location</h2>
        <p><strong>IP Address:</strong> <span id="ip">Loading...</span></p>
        <p><strong>Country:</strong> <span id="country">Loading...</span></p>
        <p><strong>Country Code:</strong> <span id="country-code">Loading...</span></p>
        <p><strong>Detected Locale:</strong> <span id="locale">Loading...</span></p>
    </div>

    <div class="test-card">
        <h2>üç™ Cookie Status</h2>
        <p><strong>Current Cookie:</strong> <code id="cookie-value">None</code></p>
        <button onclick="clearCookie()">Clear Cookie</button>
        <button onclick="setCookie('de')">Set to DE</button>
        <button onclick="setCookie('en')">Set to EN</button>
    </div>

    <div class="test-card">
        <h2>üß™ Test Scenarios</h2>
        <button onclick="testNewUser()">Test: New User (No Cookie)</button>
        <button onclick="testReturningUser('de')">Test: Returning User (DE)</button>
        <button onclick="testReturningUser('en')">Test: Returning User (EN)</button>
        <div id="test-result" style="margin-top: 15px;"></div>
    </div>

    <div class="test-card">
        <h2>üìã API Response (Raw)</h2>
        <pre id="raw-response">Fetching...</pre>
    </div>

    <script>
        // Fetch geolocation data
        async function fetchGeoData() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                document.getElementById('ip').textContent = data.ip || 'Unknown';
                document.getElementById('country').textContent = data.country_name || 'Unknown';
                document.getElementById('country-code').textContent = data.country_code || 'Unknown';
                
                const germanCountries = ['DE', 'AT', 'CH', 'LI', 'LU'];
                const locale = germanCountries.includes(data.country_code) ? 'de' : 'en';
                document.getElementById('locale').textContent = locale.toUpperCase();
                document.getElementById('locale').style.fontWeight = 'bold';
                document.getElementById('locale').style.color = locale === 'de' ? '#dc2626' : '#2563eb';
                
                document.getElementById('raw-response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('ip').textContent = 'Error';
                document.getElementById('country').textContent = 'Error';
                document.getElementById('country-code').textContent = 'Error';
                document.getElementById('locale').textContent = 'Error';
                document.getElementById('raw-response').textContent = 'Error: ' + error.message;
            }
        }

        // Cookie utilities
        function getCookie() {
            const match = document.cookie.match(/(?:^|; )locale=(en|de)/);
            return match ? match[1] : null;
        }

        function setCookie(value) {
            const maxAge = 60 * 60 * 24 * 365; // 1 year
            document.cookie = `locale=${value}; Path=/; Max-Age=${maxAge}; SameSite=Lax`;
            updateCookieDisplay();
            showResult(`Cookie set to: ${value}`, 'success');
        }

        function clearCookie() {
            document.cookie = 'locale=; Path=/; Max-Age=0';
            updateCookieDisplay();
            showResult('Cookie cleared', 'success');
        }

        function updateCookieDisplay() {
            const cookie = getCookie();
            document.getElementById('cookie-value').textContent = cookie || 'None';
        }

        // Test functions
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('test-result');
            resultDiv.innerHTML = `<div class="test-card ${type}"><strong>${message}</strong></div>`;
        }

        async function testNewUser() {
            clearCookie();
            showResult('Testing new user scenario... (Cookie cleared)', 'info');
            
            setTimeout(async () => {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const germanCountries = ['DE', 'AT', 'CH', 'LI', 'LU'];
                const expectedLocale = germanCountries.includes(data.country_code) ? 'de' : 'en';
                
                showResult(
                    `New user from ${data.country_name} (${data.country_code}) should redirect to: /${expectedLocale}`,
                    'success'
                );
            }, 500);
        }

        function testReturningUser(locale) {
            setCookie(locale);
            showResult(
                `Returning user with locale=${locale} cookie should redirect to: /${locale}`,
                'success'
            );
        }

        // Initialize
        fetchGeoData();
        updateCookieDisplay();
    </script>
</body>
</html>
